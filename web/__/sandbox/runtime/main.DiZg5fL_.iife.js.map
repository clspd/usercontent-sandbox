{"version":3,"file":"main.DiZg5fL_.iife.js","names":[],"sources":["../../../config.json","../../../../src/sha256.js","../../../../src/domain.js","../../../../src/usercontent/message.js","../../../../src/management/message.js","../../../../src/main.ts","../../../../src/ucs-runtime.ts"],"sourcesContent":["{\n    \"AUTO_REGISTER\": false,\n    \"HOST_BASE\": \"usercontent.clspd.top\",\n    \"TRUSTED_ORIGINS\": []\n}","export async function asha256(arrayBuffer) {\r\n    return Array.from(new Uint8Array(await crypto.subtle.digest('SHA-256', arrayBuffer))).map(b => b.toString(16).padStart(2, '0')).join('');\r\n}\r\nexport default async function sha256(input) {\r\n    return await asha256((new TextEncoder()).encode(input));\r\n}\r\nexport { sha256 };\r\nexport async function bsha256(blob) {\r\n    return await asha256(await blob.arrayBuffer());\r\n}","import { HOST_BASE, TRUSTED_ORIGINS } from '../web/config.json' with { type: 'json' };\r\nimport sha256 from './sha256.js';\r\nexport const hostname = window.location.hostname;\r\nexport const isCorrectHostname = hostname.endsWith(HOST_BASE);\r\nexport const prefix = isCorrectHostname ? hostname.slice(0, hostname.length - HOST_BASE.length) : '';\r\n\r\nconst publicSiteRegex = /^public(\\d+)\\.$/;\r\nconst specificSiteRegex = /^([a-z0-9]+?)-([a-f0-9]+?)\\.$/; // 1: random id 2: sha256(origin).substring(0, 32)\r\n\r\nexport const isPublicSite = publicSiteRegex.test(prefix);\r\nexport const publicSiteId = isPublicSite ? publicSiteRegex.exec(prefix)[1] : '';\r\n\r\nexport const isSpecificSite = specificSiteRegex.test(prefix);\r\nexport const [specificSiteId, specificSiteHash] = isSpecificSite ? specificSiteRegex.exec(prefix) : ['', ''];\r\n\r\nexport const cachedDomainName2Hash = new Map();\r\n\r\nexport async function getDomainHash(domainName) {\r\n    if (cachedDomainName2Hash.has(domainName)) {\r\n        return cachedDomainName2Hash.get(domainName);\r\n    }\r\n    const hash = (await sha256(domainName)).substring(0, 32);\r\n    cachedDomainName2Hash.set(domainName, hash);\r\n    return hash;\r\n}\r\n\r\nexport async function checkOrigin(origin, allowPublic = true) {\r\n    if (isPublicSite) return allowPublic;\r\n    if (TRUSTED_ORIGINS.includes(origin)) return true;\r\n    if (!isSpecificSite) return false;\r\n    const domainHash = await getDomainHash(origin);\r\n    return domainHash === specificSiteHash;\r\n}\r\n","import { checkOrigin } from \"../domain.js\";\r\n\r\nexport function setupEventHandlers() { \r\n    globalThis.addEventListener('message', handleMessage);\r\n}\r\n\r\nfunction reply(event, data) {\r\n    return event.source.postMessage(data, event.origin);\r\n}\r\n\r\n/**\r\n * @param {MessageEvent} event \r\n */\r\nexport async function handleMessage(event) {\r\n    const { data, origin } = event;\r\n    if (!await checkOrigin(origin)) return;\r\n    if (!data || typeof data !== 'object') return;\r\n\r\n    switch (data.type) {\r\n        case 'ping':\r\n            return reply(event, { type: 'pong' });\r\n            break;\r\n            \r\n        case 'render':\r\n            try {\r\n                document.documentElement.outerHTML = data.code;\r\n                return reply(event, {\r\n                    type: 'renderResult',\r\n                    success: true,\r\n                });\r\n            } catch (error) {\r\n                return reply(event, {\r\n                    type: 'renderResult',\r\n                    success: false,\r\n                    error: String(error),\r\n                    stack: String(error?.stack),\r\n                });\r\n            }\r\n            break;\r\n        \r\n        case 'evaluate':\r\n            try {\r\n                const config = data.config || {};\r\n                let result;\r\n                if (config.unwrap) {\r\n                    result = new Function('return eval(arguments[0])')(data.code);\r\n                }\r\n                else {\r\n                    let body;\r\n                    if (config.topLevelAwait) body = `return ((async function () { ${data.code} })());`;\r\n                    else if (config.simple) body = `return (() => ${data.code})();`;\r\n                    else body = data.code;\r\n                    result = await (new Function(body))();\r\n                }\r\n                return reply(event, {\r\n                    type: 'evaluateResult',\r\n                    success: true,\r\n                    result,\r\n                });\r\n            } catch (error) {\r\n                return reply(event, {\r\n                    type: 'evaluateResult',\r\n                    success: false,\r\n                    error: String(error),\r\n                    stack: String(error?.stack),\r\n                });\r\n            }\r\n            break;\r\n    \r\n        default:\r\n            break;\r\n    }\r\n}\r\n","import { checkOrigin } from \"../domain.js\";\r\n\r\nexport function setupEventHandlers() { \r\n    globalThis.addEventListener('message', handleMessage);\r\n}\r\n\r\nfunction reply(event, data) {\r\n    return event.source.postMessage(data, event.origin);\r\n}\r\n\r\n/**\r\n * @param {MessageEvent} event \r\n */\r\nexport async function handleMessage(event) {\r\n    const { data, origin } = event;\r\n    if (!await checkOrigin(origin, false)) return;\r\n    if (!data || typeof data !== 'object') return;\r\n\r\n    switch (data.type) {\r\n        case 'ping':\r\n            return reply(event, { type: 'pong' });\r\n            break;\r\n        \r\n        case 'isAvailable':\r\n            return reply(event, {\r\n                type: 'isAvailable',\r\n                result: await (async () => {\r\n                    try {\r\n                        const { serviceWorkerAvailable } = await import('../swAvailable.ts');\r\n                        return serviceWorkerAvailable();\r\n                    } catch { return false }\r\n                })()\r\n            });\r\n            break;\r\n        \r\n        case 'isWorkable':\r\n            return reply(event, {\r\n                type: 'isWorkable',\r\n                result: await (async () => {\r\n                    try {\r\n                        const { serviceWorkerWorking } = await import('../swAvailable.ts');\r\n                        return serviceWorkerWorking();\r\n                    } catch { return false }\r\n                })()\r\n            });\r\n            break;\r\n            \r\n        case 'register':\r\n            try {\r\n                await navigator.serviceWorker.register(\"/__service_worker__.js\", { scope: \"/\" });\r\n                return reply(event, {\r\n                    type: 'registerResult',\r\n                    success: true\r\n                });\r\n            } catch (error) {\r\n                return reply(event, {\r\n                    type: 'registerResult',\r\n                    success: false,\r\n                    reason: String(error),\r\n                    stack: String(error?.stack)\r\n                });\r\n            }\r\n    \r\n        default:\r\n            break;\r\n    }\r\n}\r\n","import { AUTO_REGISTER } from '../web/config.json' with { type: 'json' };\n\nexport async function usercontent_main() {\n    const { setupEventHandlers } = await import(\"./usercontent/message.js\");\n    setupEventHandlers();\n\n    console.log('[usercontent]', 'load success');\n}\n\n\nexport async function main() {\n    const { serviceWorkerAvailable } = await import('./swAvailable.ts');\n    if (serviceWorkerAvailable() && AUTO_REGISTER) {\n        navigator.serviceWorker.register(\"/__service_worker__.js\", { scope: \"/\" })\n            .then(function (registration) {\n                console.log('[usercontent]', 'service worker has been registered');\n            })\n            .catch(function (error) {\n                console.error('[usercontent]', 'Unable to register service worker:', error);\n            });\n    }\n\n    const { setupEventHandlers } = await import(\"./management/message.js\");\n    setupEventHandlers();\n\n    console.log('[usercontent]', 'load success');\n}\n","import { usercontent_main } from './main';\nusercontent_main();\n"],"mappings":"+LCAA,eAAsB,EAAQ,EAAa,CACvC,OAAO,MAAM,KAAK,IAAI,WAAW,MAAM,OAAO,OAAO,OAAO,UAAW,EAAY,CAAC,CAAC,CAAC,IAAI,GAAK,EAAE,SAAS,GAAG,CAAC,SAAS,EAAG,IAAI,CAAC,CAAC,KAAK,GAAG,CAE5I,eAA8B,EAAO,EAAO,CACxC,OAAO,MAAM,EAAS,IAAI,aAAa,CAAE,OAAO,EAAM,CAAC,mBCa3D,eAAsB,EAAc,EAAY,CAC5C,GAAI,EAAsB,IAAI,EAAW,CACrC,OAAO,EAAsB,IAAI,EAAW,CAEhD,IAAM,GAAQ,MAAM,EAAO,EAAW,EAAE,UAAU,EAAG,GAAG,CAExD,OADA,EAAsB,IAAI,EAAY,EAAK,CACpC,EAGX,eAAsB,EAAY,EAAQ,EAAc,GAAM,CAK1D,OAJI,EAAqB,EACrB,EAAgB,SAAS,EAAO,CAAS,GACxC,EACc,MAAM,EAAc,EAAO,GACxB,EAFM,wCA7BsD,IACrD,CACpB,EAAW,OAAO,SAAS,SAC3B,EAAoB,EAAS,SAAS,EAAU,CAChD,EAAS,EAAoB,EAAS,MAAM,EAAG,EAAS,OAAS,EAAU,OAAO,CAAG,GAE5F,EAAkB,kBAClB,EAAoB,gCAEb,EAAe,EAAgB,KAAK,EAAO,CAC5B,GAAe,EAAgB,KAAK,EAAO,CAAC,GAE3D,EAAiB,EAAkB,KAAK,EAAO,CAC/C,CAAC,EAAgB,GAAoB,EAAiB,EAAkB,KAAK,EAAO,CAAG,CAAC,GAAI,GAAG,CAE/F,EAAwB,IAAI,2DCbzC,SAAgB,GAAqB,CACjC,WAAW,iBAAiB,UAAW,EAAc,CAGzD,SAAS,EAAM,EAAO,EAAM,CACxB,OAAO,EAAM,OAAO,YAAY,EAAM,EAAM,OAAO,CAMvD,eAAsB,EAAc,EAAO,CACvC,GAAM,CAAE,OAAM,UAAW,EACpB,SAAM,EAAY,EAAO,EAC1B,GAAC,GAAQ,OAAO,GAAS,UAE7B,OAAQ,EAAK,KAAb,CACI,IAAK,OACD,OAAO,EAAM,EAAO,CAAE,KAAM,OAAQ,CAAC,CAGzC,IAAK,SACD,GAAI,CAEA,MADA,UAAS,gBAAgB,UAAY,EAAK,KACnC,EAAM,EAAO,CAChB,KAAM,eACN,QAAS,GACZ,CAAC,OACG,EAAO,CACZ,OAAO,EAAM,EAAO,CAChB,KAAM,eACN,QAAS,GACT,MAAO,OAAO,EAAM,CACpB,MAAO,OAAO,GAAO,MAAM,CAC9B,CAAC,CAEN,MAEJ,IAAK,WACD,GAAI,CACA,IAAM,EAAS,EAAK,QAAU,EAAE,CAC5B,EACJ,GAAI,EAAO,OACP,EAAa,SAAS,4BAA4B,CAAC,EAAK,KAAK,KAE5D,CACD,IAAI,EACJ,AAEK,EAFD,EAAO,cAAsB,gCAAgC,EAAK,KAAK,SAClE,EAAO,OAAe,iBAAiB,EAAK,KAAK,MAC9C,EAAK,KACjB,EAAS,MAAW,SAAS,EAAK,EAAG,CAEzC,OAAO,EAAM,EAAO,CAChB,KAAM,iBACN,QAAS,GACT,SACH,CAAC,OACG,EAAO,CACZ,OAAO,EAAM,EAAO,CAChB,KAAM,iBACN,QAAS,GACT,MAAO,OAAO,EAAM,CACpB,MAAO,OAAO,GAAO,MAAM,CAC9B,CAAC,CAEN,MAEJ,QACI,wBAtE+B,IEE3C,eAAsB,GAAmB,CACrC,GAAM,CAAE,mBAAA,GAAuB,MAAA,QAAA,SAAA,CAAA,UAAA,GAAA,CAAA,GAAA,CAC/B,GAAoB,CAEpB,QAAQ,IAAI,gBAAiB,eAAe,CCLhD,GAAkB"}